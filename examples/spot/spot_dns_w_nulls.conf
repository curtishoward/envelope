application {
    name = Spot DNS ingest 
    batch.milliseconds = 5000
    executors = 1
    executor.cores = 1
    executor.memory = 1G
    spark.conf.hive.exec.dynamic.partition = true
    spark.conf.hive.exec.dynamic.partition.mode = nonstrict 
}

steps {
    dns_received {
        input {
            type = kafka
            brokers = "cjh-1.vpc.cloudera.com:9092"
            topic = traffic
            encoding = string
            translator {
                type = delimited
                delimiter = ","
                field.names = [event_time1,event_time2,epoch,dns_len,src_ip4_str,dst_ip4_str,dns_query,dns_type,dns_class,dns_response_code,dns_answers]
                field.types = [string,string,float,int,string,string,string,int,string,string,string]
            }
        }
    }
    
    dns_formatted {
        dependencies = [dns_received]
        deriver {
            type = sql
            query.literal = """
                SELECT 
                  unix_timestamp(concat(event_time1, event_time2), "MMM dd yyyy HH:mm:ss") as event_time, 
                  NULL as begin_time, NULL as end_time, NULL as event_insert_time, NULL as last_update_time, NULL as duration, NULL as event_id, NULL as name, NULL as org, NULL as type, NULL as n_proto, NULL as a_proto, NULL as msg, NULL as mac, NULL as severity, NULL as raw, NULL as risk, NULL as code, NULL as category, NULL as query, NULL as service, NULL as state, NULL as in_bytes, NULL as out_bytes, NULL as xref, NULL as version, NULL as api, NULL as parameter, NULL as action, NULL as proc, NULL as app, NULL as disposition, NULL as prevalence, NULL as confidence, NULL as sensitivity, NULL as count, NULL as company, NULL as additional_attrs, NULL as totrust, NULL as fromtrust, NULL as rule, NULL as threat, NULL as pcap_id, NULL as dvc_time, NULL as dvc_ip4, NULL as dvc_ip4_str, NULL as dvc_ip6, NULL as dvc_ip6_str, NULL as dvc_host, NULL as dvc_domain, NULL as dvc_type, NULL as dvc_vendor, NULL as dvc_fwd_ip4, NULL as dvc_fwd_ip4_str, NULL as dvc_fwd_ip6, NULL as dvc_fwd_ip6_str, NULL as dvc_version, NULL as src_ip4,
                  src_ip4_str, 
                  NULL as src_ip6,
                  NULL as src_ip6_str, NULL as src_host, NULL as src_domain, NULL as src_port, NULL as src_country_code, NULL as src_country_name, NULL as src_region, NULL as src_city, NULL as src_lat, NULL as src_long, NULL as dst_ip4,
                  dst_ip4_str,
                  NULL as dst_ip6, NULL as dst_ip6_str, NULL as dst_host, NULL as dst_domain, NULL as dst_port, NULL as dst_country_code, NULL as dst_country_name, NULL as dst_region, NULL as dst_city, NULL as dst_lat, NULL as dst_long, NULL as src_asn, NULL as dst_asn, NULL as net_direction, NULL as net_flags, NULL as file_name, NULL as file_path, NULL as file_atime, NULL as file_acls, NULL as file_type, NULL as file_size, NULL as file_desc, NULL as file_hash, NULL as file_hash_type, NULL as end_object, NULL as end_action, NULL as end_msg, NULL as end_app, NULL as end_location, NULL as end_proc, NULL as user_name, NULL as src_user_name, NULL as dst_user_name, NULL as user_email, NULL as user_id, NULL as user_loc, NULL as user_desc, 
                  dns_class, 
                  dns_len, 
                  dns_query,
                  dns_response_code,
                  dns_answers,
                  dns_type, 
                  NULL as prx_category, NULL as prx_browser, NULL as prx_code, NULL as prx_referrer, NULL as prx_host, NULL as prx_filter_rule, NULL as prx_filter_result, NULL as prx_query, NULL as prx_action, NULL as prx_method, NULL as prx_type, NULL as http_request_method, NULL as http_request_uri, NULL as http_request_body_len, NULL as http_request_user_name, NULL as http_request_password, NULL as http_request_proxied, NULL as http_request_headers, NULL as http_response_status_code, NULL as http_response_status_msg, NULL as http_response_body_len, NULL as http_response_info_code, NULL as http_response_info_msg, NULL as http_response_resp_fuids, NULL as http_response_mime_types, NULL as http_response_headers, NULL as smtp_trans_depth, NULL as smtp_headers_helo, NULL as smtp_headers_mailfrom, NULL as smtp_headers_rcptto, NULL as smtp_headers_date, NULL as smtp_headers_from, NULL as smtp_headers_to, NULL as smtp_headers_reply_to, NULL as smtp_headers_msg_id, NULL as smtp_headers_in_reply_to, NULL as smtp_headers_subject, NULL as smtp_headers_x_originating_ip4, NULL as smtp_headers_x_originating_ip4_str, NULL as smtp_headers_first_received, NULL as smtp_headers_second_received, NULL as smtp_last_reply, NULL as smtp_path, NULL as smtp_user_agent, NULL as smtp_tls, NULL as smtp_is_webmail, NULL as ftp_user_name, NULL as ftp_password, NULL as ftp_command, NULL as ftp_arg, NULL as ftp_mime_type, NULL as ftp_file_size, NULL as ftp_reply_code, NULL as ftp_reply_msg, NULL as ftp_data_channel_passive, NULL as ftp_data_channel_rsp_p, NULL as ftp_cwd, NULL as ftp_cmdarg_ts, NULL as ftp_cmdarg_cmd, NULL as ftp_cmdarg_arg, NULL as ftp_cmdarg_seq, NULL as ftp_pending_commands, NULL as ftp_is_passive, NULL as ftp_fuid, NULL as ftp_last_auth_requested, NULL as snmp_version, NULL as snmp_community, NULL as snmp_get_requests, NULL as snmp_get_bulk_requests, NULL as snmp_get_responses, NULL as snmp_set_requests, NULL as snmp_display_string, NULL as snmp_up_since, NULL as tls_version, NULL as tls_cipher, NULL as tls_curve, NULL as tls_server_name, NULL as tls_resumed, NULL as tls_next_protocol, NULL as tls_established, NULL as tls_cert_chain_fuids, NULL as tls_client_cert_chain_fuids, NULL as tls_subject, NULL as tls_issuer, NULL as ssh_version, NULL as ssh_auth_success, NULL as ssh_client, NULL as ssh_server, NULL as ssh_cipher_algorithm, NULL as ssh_mac_algorithm, NULL as ssh_compression_algorithm, NULL as ssh_key_exchange_algorithm, NULL as ssh_host_key_algorithm, NULL as dhcp_assigned_ip4, NULL as dhcp_assigned_ip4_str, NULL as dhcp_mac, NULL as dhcp_lease_time, NULL as irc_user, NULL as irc_nickname, NULL as irc_command, NULL as irc_value, NULL as irc_additional_data, NULL as flow_in_packets, NULL as flow_out_packets, NULL as flow_conn_state, NULL as flow_history, NULL as flow_src_dscp, NULL as flow_dst_dscp, NULL as flow_input, NULL as flow_output, NULL as vuln_id, NULL as vuln_type, NULL as vuln_status, NULL as vuln_severity, NULL as av_riskname, NULL as av_actualaction, NULL as av_requestedaction, NULL as av_secondaryaction, NULL as av_downloadsite, NULL as av_downloadedby, NULL as av_tracking_status, NULL as av_firstseen, NULL as application_hash, NULL as application_hash_type, NULL as application_name, NULL as application_version, NULL as application_type, NULL as av_categoryset, NULL as av_categorytype, NULL as av_threat_count, NULL as av_infected_count, NULL as av_omitted_count, NULL as av_scanid, NULL as av_startmessage, NULL as av_stopmessage, NULL as av_totalfiles, NULL as av_signatureid, NULL as av_signaturestring, NULL as av_signaturesubid, NULL as av_intrusionurl, NULL as av_intrusionpayloadurl, NULL as objectname, 
                  'SOME_VENDOR' as p_dvc_vendor,
                  'SOME_DEVICE_TYPE' as p_dvc_type,
                  FROM_UNIXTIME(unix_timestamp(concat(event_time1, event_time2), "MMM dd yyyy HH:mm:ss"), "yyyy-MM-dd") as p_dt
                FROM dns_received"""
        }
        planner {
            type = append 
        }
        output {
            type = hive
            table = "spot.event"
        }
    }
}
